<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>lean4web</title>
</head>
<body>
    <script>

    const IO = {
      _resolveGetLine: null,
      _resolveRead: null,
      _readPointer: null,
      _nbytes: 0,
      bufferStdIn : "",
      async getLine() {
        return new Promise((resolve, reject) => {
            this._resolveGetLine = resolve
            this.flushStdIn();
        });
      },
      async read(ptr, nbytes) {
        console.log(`read ${nbytes}`)
        this._nbytes = nbytes
        this._readPointer = ptr
        return new Promise((resolve, reject) => {
            this._resolveRead = resolve
            this.flushStdIn();
        });
      },
      flushStdIn() {
        if(this._resolveGetLine) {
          var lineBreak = this.bufferStdIn.indexOf("\n")
          if (lineBreak != -1) {
            this._resolveGetLine(stringToNewUTF8(this.bufferStdIn.substring(0,lineBreak+1)))
            this.bufferStdIn = this.bufferStdIn.substring(lineBreak+1)
            this._resolveGetLine = null
          }
        }
        if(this._resolveRead) {
          console.log(`read: ${this.bufferStdIn}`)
          stringToUTF8(this.bufferStdIn, this._readPointer, this._nbytes);
          this._resolveRead()
          this.bufferStdIn = ""
          this._resolveRead = null
        }
      },
      putLine(data) {
        const str = data + '\r\n'
        const byteLength = lengthBytesUTF8(str)
        this.bufferStdIn += `Content-Length: ${byteLength}\r\n\r\n` + str
        this.flushStdIn();
      }
    }


    var input = ""
    var i = 0;

    function submit (ev) {
    ev.preventDefault()
    return false;
    }

    var stdoutBuffer = ""
    var stderrBuffer = ""

    setInterval(() => {
      if (stdoutBuffer.length > 0) {
        console.log("STDOUT: " + stdoutBuffer);
        stdoutBuffer = ""
      }
      if (stderrBuffer.length > 0) {
        console.error("STDERR: " + stderrBuffer);
        stderrBuffer = ""
      }
    },500)


    var Module = {
        "arguments": ["--worker"],
        "preRun": function() {
        function stdin() {
            if (i < input.length) {
              i++;
              return input.charCodeAt(i);// Return ASCII code of character, or null if no input
            } else {
              return null
            }
        }

        function stdout(asciiCode) {
          stdoutBuffer += String.fromCharCode(asciiCode)
        }

        function stderr(asciiCode) {
          stderrBuffer += String.fromCharCode(asciiCode)
        }

        FS.init(stdin, stdout, stderr);
    }};
    </script>
    <script src="bin/lean.js"></script>
    <script>

    // var js_wrapped_fib = Module.cwrap("fib", "number", ["number"]);
    
    function pressBtn(){
        // console.log("The result of fib(5) is:", js_wrapped_fib(5));
    }
    </script>
    <form onsubmit="input = document.getElementById('input').value + '\\n'; return false;">
    <input type="text" id="input">
    <button onclick="IO.putLine(document.getElementById('input').value)">Click me!</button>
  </form>
    <p>Open the console to see the result!</p>
</body>
</html>
